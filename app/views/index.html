<html lang="en">

<head>
    <link rel="stylesheet" href="static/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <title>Homepage</title>
</head>



<body>


    <header class="header border-bottom-1px">
        <a href="#" class="logo">Logo</a>

        <nav class="navbar">
            <a href="#">Home</a>
            <a href="#">Content</a>
            <a href="#">About Us</a>
            <a href="#">Contact Us</a>
        </nav>
    </header>

    <div class="selection-container">

        <div class="datepicker-container center">
            <div id="datepicker" class="column">
                <div id="daterange"></div>
                <div id="date-display">
                    <p id="date-display-text" class="border-small center"></p>
                    <button id="date-display-clear" class="border-small">X</button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="options-container">
                <div class="grid-container">
                    <div class="status center">
                        <div class="">Status</div>
                        <div class="status-checkbox">
                            <label><input id="scheduled-checkbox" type="checkbox" value="scheduled">Scheduled</label>
                            <label><input id="ongoing-checkbox" type="checkbox" value="ongoing">Ongoing</label>
                            <label><input id="played-checkbox" type="checkbox" value="played">Played</label>
                        </div>
                    </div>

                    <div class="status-venue center">
                        <label><input id="venue-name" placeholder="Venue Name">Venue Name</label>
                    </div>
                    <div class="status-team center">
                        <label><input id="team-name" placeholder="Team Name">Team Name</label>
                    </div>

                    <div class="status-competition center">
                        <label><select id="select-competition">
                                <option value="">-</option>
                            </select>Competition</label>
                    </div>

                </div>



            </div>

            <div class="find-container center">
                <button class="find-button border-small" onclick="getMatches()">Find Games</button>
            </div>



        </div>

    </div>

    <footer class="footer border-top-1px"></footer>

    <input type="file" name="file" id="file-input" accept=".json">
</body>

<script>

    const fileInput = document.getElementById("file-input")
    fileInput.addEventListener("change", async function () {
        const file = fileInput.files[0]

        const formData = new FormData();
        formData.append("file", file);

        const options = {
            method: 'POST',
            body: formData
        };

        if (file && file.type === "application/json") {
            x = await makeRequest('/upload', options)
            console.log(x)
        }
    })

    function dateFormatter(date) {
        let formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${(date.getDate()).toString().padStart(2, '0')}`
        return formattedDate
    }

    let startDate = "";
    let endDate = "";
    document.addEventListener('DOMContentLoaded', function () {

        const display_date = document.getElementById("date-display-text")
        const button_clear_date = document.getElementById("date-display-clear")



        flatpickr("#daterange", {
            mode: "range",
            inline: true,

            onChange: function (selectedDates) {
                startDate = dateFormatter(selectedDates[0])

                endDate = undefined
                if (selectedDates[1]) {
                    endDate = dateFormatter(selectedDates[1])

                }

                display_date.textContent = endDate ? `${startDate} to ${endDate}` : `${startDate}`;

            },

            onClose: function (selectedDates) {
                startDate = dateFormatter(selectedDates[0])
                endDate = dateFormatter(selectedDates[1])

            }
        });

        button_clear_date.addEventListener('click', function () {
            display_date.textContent = "";
        })

    });


</script>


<script>
    /**
     * Sets option in select input for each competition in data
     * 
     * @param {Object} data - Object that contains all available competitions
     * 
     */
    function setCompetitionSelect(data) {
        const competitionSelect = document.getElementById("select-competition")

        for (const item of data) {
            const option = document.createElement('option')

            option.value = item
            option.textContent = item

            competitionSelect.appendChild(option)

        }
    }


    function getCheckboxStatus() {

        const scheduledCheckbox = document.getElementById("scheduled-checkbox")
        const ongoingCheckbox = document.getElementById("ongoing-checkbox")
        const playedCheckbox = document.getElementById("played-checkbox")

        const selectedValues = []

        if (scheduledCheckbox.checked) {
            selectedValues.push(scheduledCheckbox.value);
        }
        if (ongoingCheckbox.checked) {
            selectedValues.push(ongoingCheckbox.value);
        }
        if (playedCheckbox.checked) {
            selectedValues.push(playedCheckbox.value);
        }

        return selectedValues

    }

    function getVenueName() {
        const venueNameInput = document.getElementById("venue-name")
        const venueName = venueNameInput.value
        const trimmedVenueName = venueName.trim()

        if(trimmedVenueName === ""){
            return null
        }
        return trimmedVenueName
    }

    function getTeamName() {
        const teamNameInput = document.getElementById("team-name")
        const teamName = teamNameInput.value
        const trimmedTeamName = teamName.trim()

        if(trimmedTeamName === ""){
            return null
        }

        return trimmedTeamName
    }

    function getCompetitionName() {
        const competitionNameSelect = document.getElementById("select-competition")
        const competitionName = competitionNameSelect.value
        const trimmedCompetitionName = competitionName.trim()

        if(trimmedCompetitionName === ""){
            return null
        }
        return trimmedCompetitionName
    }

</script>


<script>

    const BASE_URL = 'http://127.0.0.1:5000'

    /**
     * Sends an HTTP request to specified url with provided options
     * 
     * @param {string} endpoint - Endpoint to API
     * @param {object} options - Settings for request, such as method, headers and body. Defaults to { method: 'GET' }
     * 
     * @returns {Promise<Object>} - Promise which resolves into JSON response if successful
     * 
     */
    async function makeRequest(endpoint, options = { method: 'GET' }) {
        const url = `${BASE_URL}${endpoint}`

        try {
            let response = await fetch(url, options)

            if (!response.ok) {
                throw new Error(`HTTP Error! Status: ${response.status}`)
            }

            return response.json()

        } catch (error) {
            console.error(`ERROR ${error}`)
            return { success: false, message: error.message }
        }
    }


    async function getMatches() {

        const config = {
            "startDate": startDate,
            "endDate": endDate,
            "status": getCheckboxStatus(),
            "venueName": getVenueName(),
            "teamName": getTeamName(),
            "competition": getCompetitionName()
        }

        const options = {
            method: "POST",
            headers: {
                "Content-Type": "application/json" // Specify content type
            },
            body: JSON.stringify(config)
        }

        let data = await makeRequest('/getMatches', options)
        console.log(data)
    }


    /**
     * Sends HTTP GET request to '/competitions' API
     * Sets options in select element for every competition 
     * 
     * @returns {Promise<object>} - Object with all available competitions, setting select input options
     */
    async function getCompetitions() {

        const options = {
            method: 'GET'
        };

        let data = await makeRequest('/getCompetitions', options)

        setCompetitionSelect(data)

    }
    getCompetitions()
</script>

</html>